<!DOCTYPE html>
<html lang="en" class="position-relative">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Prefetch DNS for faster page speed -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="dns-prefetch" href="//google-analytics.com" />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com" />
    <link rel="dns-prefetch" href="//ajax.googleapis.com" />
    <link rel="dns-prefetch" href="//fonts.gstatic.com" />
    
    <!-- Prefetch disqus DNS for faster page speed -->
    <link rel="dns-prefetch" href="https://lklab-github-io-blog.disqus.com/" />
      <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>JNI 객체 사용과 메모리 관리 | Avopado</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="JNI 객체 사용과 메모리 관리" />
<meta name="author" content="khlee" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="개요" />
<meta property="og:description" content="개요" />
<link rel="canonical" href="http://localhost:4000/blog/Object_and_memory/" />
<meta property="og:url" content="http://localhost:4000/blog/Object_and_memory/" />
<meta property="og:site_name" content="Avopado" />
<meta property="og:image" content="http://localhost:4000/assets/post/18-07-04-Object_and_memory/title.jpeg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-04T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/post/18-07-04-Object_and_memory/title.jpeg" />
<meta property="twitter:title" content="JNI 객체 사용과 메모리 관리" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"khlee"},"dateModified":"2018-07-04T00:00:00+09:00","datePublished":"2018-07-04T00:00:00+09:00","description":"개요","headline":"JNI 객체 사용과 메모리 관리","image":"http://localhost:4000/assets/post/18-07-04-Object_and_memory/title.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/blog/Object_and_memory/"},"url":"http://localhost:4000/blog/Object_and_memory/"}</script>
<!-- End Jekyll SEO tag -->
 

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/assets/css/main.css" />

    <!-- Fontawesome Icons CSS -->
    <link
      rel="stylesheet"
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <!-- Replace these icons with your own. -->

    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/assets/img/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/assets/img/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/assets/img/apple-icon-152x152.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/assets/img/android-icon-192x192.png"
    />
    <link
      rel="shortcut icon"
      href="/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="icon"
      href="/favicon.ico"
      type="image/x-icon"
    />

    

    <!-- Google Analytics code. <head> tag is the right place for analytics code as directed by Google. This is unofficial light version which loads blazing fast! Implemented for faster page load.  -->
    <script src="https://cdn.jsdelivr.net/npm/ga-lite@1/dist/ga-lite.min.js" async></script>
<script>
var galite = galite || {};
galite.UA = 'G-LYHC56N0SX'; 
</script>  
    <script
      async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML"
    ></script>
     
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    
    <noscript>
      <style>
        .loader {
          display: none;
        }
        .dropdown-menu {
          display: block;
        }
        .rev {
          visibility: visible;
        }
        .owl-carousel {
          display: flex;
        }
        .owl-carousel.carousel-1 {
          display: block;
        }
      </style>
    </noscript>
  </head>

  <body>
    <noscript
      ><div
        class="bg-danger text-white text-center position-absolute"
        style="z-index: 9999999; left: 0; right: 0; top: 0"
      >
        Please enable JavaScript for full functionality.
      </div></noscript
    >
    <div class="loader">
      <div class="lds-ring">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>

    <div id="top" class="wrapper">
      <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-white">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img
        src="/assets/img/apple-icon-60x60.png"
        class="d-inline-block align-top logo"
        alt="Avopado"
      />
      Avopado
    </a>
    <button
      class="navbar-toggler"
      type="button"
      data-toggle="collapse"
      data-target="#navbarNavAltMarkup"
      aria-controls="navbarNavAltMarkup"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="navbar-nav ml-auto">
         
        <a
          class="nav-item nav-link "
          href="/"
          >Home</a
        >
          
        <a
          class="nav-item nav-link "
          href="/blog/"
          >Blog</a
        >
          
        <a
          class="nav-item nav-link "
          href="/categories/"
          >Categories</a
        >
         
      </div>
    </div>
  </div>
</nav>



      <div class="content-wrapper"><!--                            
This layout is used for posts. Changing anything here will affect all posts(not pages)
 -->

<div class="post">
  <main>
    <header class="position-relative text-center rev">
      <div class="header-image" style="background-image: url(/assets/post/18-07-04-Object_and_memory/title.jpeg)"></div>
      <h1 class="post-title position-absolute">JNI 객체 사용과 메모리 관리</h1>
    </header>
    <div class="container">
      <div class="blog-content pd">
        <div class="row">
          <div class="col-md-12">
            
<ul class="breadcrumbs rev">
	<li><a href="/">Home</a></li>
	
	
	<li><a href="/blog/">Blog</a></li>
	
	
	
	<li><a href="#">JNI 객체 사용과 메모리 관리</a></li>
	
	
</ul>

          </div>
        </div>

        <div class="row">
          <div class="col-md-12 meta">
            <p><small>
                <span>
                  <i class="fa fa-calendar" aria-hidden="true"></i> 04 Jul 2018&nbsp;
                </span>
                <span>
                  <i class="fa fa-user" aria-hidden="true"></i> Khlee&nbsp;
                </span>
                <span>
                  <i class="fa fa-clock-o" aria-hidden="true"></i> 8 mins read.
                </span>
              </small></p>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">

            <article>
              
<ul class="toc rev clearfix">
  <li><a href="#개요">개요</a></li>
  <li><a href="#참고-자료">참고 자료</a></li>
  <li><a href="#string">String</a></li>
  <li><a href="#object-construction">Object construction</a></li>
  <li><a href="#array">Array</a></li>
  <li><a href="#deletelocalref">DeleteLocalRef()</a></li>
</ul>


              <h2 id="개요">개요</h2>

<p>JNI를 통해 C에서 Java의 객체에 접근할 수 있고 자유롭게 생성할 수 있다. 그러나 C에서 접근했거나 생성한 객체가 여전히 C에서 참조를 갖고 있는지 알 수 없으므로, garbage collector가 이러한 객체를 어떻게 처리할지 알 수 없게 된다. 이를 위해 JNI는 C에서 해당 객체에 대한 참조를 명시적으로 제거할 수 있는 함수를 제공하여 garbage collector가 잘 동작할 수 있도록 메커니즘이 마련되어 있다.</p>

<p>이번 글에서는 C에서 Java 객체를 사용하는 방법과, 메모리 관리 방법을 소개한다.</p>

<h2 id="참고-자료">참고 자료</h2>

<p><a href="https://www.uni-ulm.de/fileadmin/website_uni_ulm/iui.inst.200/files/staff/domaschka/misc/jni_programmers_guide_spec.pdf">The Java Native Interface: Programmer’s Guide and Specification</a></p>

<h2 id="string">String</h2>

<p>C에서 String을 처리할 수 있는 함수는 다음과 같다.</p>

<p><img src="/blog/assets/post/18-07-04-Object_and_memory/string.png" alt="string functions" /></p>

<p>다음과 같이 사용할 수 있다.</p>

<p>Hello.java</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Hello</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kd">native</span> <span class="nc">String</span> <span class="nf">getText</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>hello.c</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="nf">Java_Hello_getText</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

    <span class="cm">/* get string from java String object */</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* OutOfMemoryError already thrown */</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"received from java : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

    <span class="cm">/* free the memory allocated for msg */</span>
    <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ReleaseStringUTFChars</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

    <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>

    <span class="cm">/* create java String object */</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Java String은 <code class="highlighter-rouge">GetStringUTFChars()</code> 함수를 통해 C 문자열(캐릭터의 배열)로 가져올 수 있다.<br />
가져온 문자열은 사용이 모두 끝난 후에 <code class="highlighter-rouge">ReleaseStringUTFChars()</code> 함수를 통해 할당된 메모리 영역을 반환해야 한다.</p>

<p>C 문자열로부터 <code class="highlighter-rouge">NewStringUTF()</code> 함수를 통해 java String 객체를 생성할 수 있다.<br />
이를 통해 생성된 객체는 전적으로 java에서만 사용되는 것으로 간주되며, C에서 참조를 갖고 있더라도 garbage collector가 이를 확인하지 않으므로, java에서의 참조만 없다면 해당 객체는 제거될 수 있다.</p>

<h2 id="object-construction">Object construction</h2>

<p>객체를 생성하는 순서는 다음과 같다.</p>
<ol>
  <li>생성할 객체의 class를 얻는다.</li>
  <li>생성자(constructor)를 얻는다.</li>
  <li>생성자 매개변수와 함께 객체를 생성한다.</li>
</ol>

<p>다음은 사용 예이다.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">JNIEXPORT</span> <span class="n">jobject</span> <span class="n">JNICALL</span>
<span class="nf">Java_Hello_getObject</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">jClass</span> <span class="n">class</span><span class="p">;</span>
    <span class="n">jmethodID</span> <span class="n">constructor</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">parameter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">jobject</span> <span class="n">result</span><span class="p">;</span>

    <span class="cm">/* get class */</span>
    <span class="n">class</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"java/lang/Integer"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">class</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* get constructor */</span>
    <span class="n">constructor</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="s">"&lt;init&gt;"</span><span class="p">,</span> <span class="s">"(I)V"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">constructor</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="cm">/* construct object */</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">constructor</span><span class="p">,</span> <span class="n">parameter</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p><code class="highlighter-rouge">FindClass()</code> 함수를 통해 특정 클래스를 얻어올 수 있다. 두 번째 매개변수로 얻어올 클래스의 패키지 경로를 포함한 전체 이름을 적는다.</p>

<p><code class="highlighter-rouge">GetMethodID()</code> 함수는 특정 클래스의 메소드를 얻어오는 함수이다. 원래 세 번째 매개변수에는 메소드의 이름, 네 번째 매개변수에는 메소드의 시그니처를 넣어야 하지만, 생성자를 얻어올 경우 메소드의 이름을 <code class="highlighter-rouge">&lt;init"&gt;</code>으로, 시그니처의 반환 타입은 <code class="highlighter-rouge">void</code>를 의미하는 <code class="highlighter-rouge">V</code>로 고정해야 한다.</p>

<p>메소드 시그니처는 메소드의 반환 타입과 매개변수들의 타입을 문자열로 정의한 것으로 “({매개변수}){반환타입}” 형식이다.</p>

<p>각각 java 타입에 해당하는 시그니처는 다음과 같다.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Type</th>
      <th style="text-align: center">Signature</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">void</td>
      <td style="text-align: center">V</td>
    </tr>
    <tr>
      <td style="text-align: center">boolean</td>
      <td style="text-align: center">Z</td>
    </tr>
    <tr>
      <td style="text-align: center">byte</td>
      <td style="text-align: center">B</td>
    </tr>
    <tr>
      <td style="text-align: center">char</td>
      <td style="text-align: center">C</td>
    </tr>
    <tr>
      <td style="text-align: center">int</td>
      <td style="text-align: center">I</td>
    </tr>
    <tr>
      <td style="text-align: center">long</td>
      <td style="text-align: center">J</td>
    </tr>
    <tr>
      <td style="text-align: center">float</td>
      <td style="text-align: center">F</td>
    </tr>
    <tr>
      <td style="text-align: center">double</td>
      <td style="text-align: center">D</td>
    </tr>
    <tr>
      <td style="text-align: center">object</td>
      <td style="text-align: center">L{패키지 경로를 포함한 클래스 전체 이름};</td>
    </tr>
    <tr>
      <td style="text-align: center">type[]</td>
      <td style="text-align: center">[{해당 타입의 시그니처}</td>
    </tr>
  </tbody>
</table>

<p>예를 들어서</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">void aaa() -&gt; ()V
int bbb(boolean a, char, b) -&gt; (ZC)I
String[] ccc(int[] c, MyClass d) -&gt; ([ILmyPackage/MyClass;)[Ljava/lang/String;</code></pre></figure>

<p>이 된다.</p>

<p>마지막으로 <code class="highlighter-rouge">NewObject()</code> 함수를 통해 해당 객체를 생성한다. 4번째 파라미터부터는 지정된 생성자의 파라미터로 사용될 변수를 순서대로 넣으면 된다. 만약 생성자의 파라미터가 두 개라면 4번째 파라미터에 생성자의 1번째 파라미터, 5번째 파라미터에 생성자의 2번째 파라미터를 넣으면 된다.</p>

<h2 id="array">Array</h2>

<p>다음은 배열을 처리하는 함수들이다.</p>

<p><img src="/blog/assets/post/18-07-04-Object_and_memory/array.png" alt="array functions" /></p>

<p><code class="highlighter-rouge">&lt;Type&gt;</code>에 원하는 배열 타입을 입력하면 된다. 예를 들어 int 배열을 생성하고 싶은 경우 <code class="highlighter-rouge">NewIntArray()</code> 함수를 사용한다.</p>

<p><code class="highlighter-rouge">Get&lt;Type&gt;ArrayRegion()</code> 함수와 <code class="highlighter-rouge">Get&lt;Type&gt;ArrayElements()</code> 함수는 모두 배열의 값을 얻어올 수 있다는 공통점이 있지만 사용 방법이 다르다.</p>

<p><code class="highlighter-rouge">Get&lt;Type&gt;ArrayRegion()</code> 함수는 다음과 같이 얻어올 메모리 영역이 미리 확보되어 있을 때 사용한다.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="n">JNICALL</span>
<span class="nf">Java_Hello_sumArray</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* get int array data */</span>
    <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetIntArrayRegion</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>반면 <code class="highlighter-rouge">Get&lt;Type&gt;ArrayElements()</code> 함수는 메모리 영역이 확보된 배열 포인터를 반환한다. 따라서 해당 포인터를 모두 사용하고 난 다음에는 <code class="highlighter-rouge">Release&lt;Type&gt;ArrayElements()</code> 함수를 통해 해당 메모리 영역을 반환해야 한다.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="n">JNICALL</span>
<span class="nf">Java_Hello_sumArray</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jintArray</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* get int array data */</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">GetIntArrayElements</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="cm">/* release int array memory */</span>
    <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ReleaseIntArrayElements</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h2 id="deletelocalref">DeleteLocalRef()</h2>

<p>만약 C에서 객체를 생성하였는데, Java로 반환되지도 않고 더 이상 사용되지 않는다면 <code class="highlighter-rouge">DeleteLocalRef()</code> 함수를 통해 반드시 해당 객체에 대한 참조를 지워야 한다.</p>

<p>예를 들어 다음과 같이 object array를 만드는 경우에 배열의 각 요소는 배열에 넣은 후 반환되지 않고 더 이상 사용되지 않는다. 이 때 <code class="highlighter-rouge">DeleteLocalRef()</code> 함수를 호출해야 한다.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">JNIEXPORT</span> <span class="n">jobjectArray</span> <span class="n">JNICALL</span>
<span class="nf">Java_Hello_getNameList</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
    <span class="n">jstring</span> <span class="n">name</span><span class="p">;</span>

    <span class="n">jclass</span> <span class="n">stringClass</span><span class="p">;</span>
    <span class="n">jobjectArray</span> <span class="n">nameList</span><span class="p">;</span>

    <span class="cm">/* construct String array */</span>
    <span class="n">stringClass</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"java/lang/String"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">stringClass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">nameList</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewObjectArray</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">stringClass</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">nameList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"enter 10 names</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

        <span class="cm">/* construct new String */</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="cm">/* insert String to array */</span>
        <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SetObjectArrayElement</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">nameList</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">jobject</span><span class="p">)</span><span class="n">name</span><span class="p">);</span>

        <span class="cm">/* delete local reference */</span>
        <span class="p">(</span><span class="o">*</span><span class="n">env</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">DeleteLocalRef</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">nameList</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>


            </article>
            
            <div class="row">
  <div class="col-md-12">
    <p class="categories rev"> <span><a
          href="/categories/#jni">Jni</a></span></p>
  </div>
</div>
            


            
            
<div class="author rev">
	<div class="row">
		<div class="col-md-3">
			<img class="author-image" src="/assets/images/avocado-cover.png" alt="khlee">
		</div>
		<div class="col-md-9">
			<h5>khlee</h5>
			<p></p>
			<ul>
				
				<li><a target="_blank" href="https://github.com/lklab"><i class="fa fa-github"
							aria-hidden="true"></i></a></li>
				
				
				<li><a target="_blank" href="https://www.linkedin.com/in/kyeonghyeon-lee-6a3330132"><i class="fa fa-linkedin-square"
							aria-hidden="true"></i></a></li>
				
				
				
				
			</ul>
		</div>
	</div>
</div>

            

            
            <div id="disqus_thread"></div>
<script defer>
  (function () {
    var d = document, s = d.createElement('script');
    s.src = '//lklab-github-io-blog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the comments</noscript>
            

            <div class="recent">
	<div class="row">
		<div class="col-md-12">
			<h3>Recent Articles</h3>
		</div>
	</div>
	<div class="row">
		
		
		<div class="col-md-3 rev">
			<a class="nostyle item" href="/blog/JNI/">
				<div class="cards">
					<div class="image" style="background-image: url(/assets/post/18-06-22-JNI/title.jpeg)"></div>
					<p class="title"><small>JNI로 C와 Java 연동하기</small></p>
				</div>
			</a>
		</div>
		
		
		
		<div class="col-md-3 rev">
			<a class="nostyle item" href="/blog/Font-Display/">
				<div class="cards">
					<div class="image" style="background-image: url(/assets/post/18-05-03-Font-Display/oled.jpg)"></div>
					<p class="title"><small>임베디드 환경에서 폰트 출력하기</small></p>
				</div>
			</a>
		</div>
		
		
		
		<div class="col-md-3 rev">
			<a class="nostyle item" href="/blog/IgH-EtherCAT/">
				<div class="cards">
					<div class="image" style="background-image: url(/assets/post/18-02-14-IgH-EtherCAT/ethercat.jpg)"></div>
					<p class="title"><small>IgH EtherCAT Master Stack API 분석</small></p>
				</div>
			</a>
		</div>
		
		
		
		<div class="col-md-3 rev">
			<a class="nostyle item" href="/blog/ARM-Linux-Cross-Compile/">
				<div class="cards">
					<div class="image" style="background-image: url(/assets/post/17-10-27-ARM-Linux-Cross-Compile/satellite.jpg)"></div>
					<p class="title"><small>Windows에서 ARM Linux 크로스 컴파일 환경 구성하기</small></p>
				</div>
			</a>
		</div>
		
		
	</div>
</div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div></div>

      <a href="#top" class="scrollup"
        ><i class="fa fa-long-arrow-up" aria-hidden="true"></i
      ></a>
      <footer>
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <div class="logo-box">
          <img width="30" src="/assets/images/avocado-transparent-small.png"
            alt="Avopado" />
          <h3>Avopado</h3>
          <p></p>
        </div>
      </div>
      <div class="col-md-2">
        <h3>Pages</h3>
        <ul>
          
          <li><a href="/">Home</a></li>
          
          <li><a href="/blog/">Blog</a></li>
          
          <li><a href="/categories/">Categories</a></li>
          
        </ul>
      </div>
      <div class="col-md-3">
        <h3>Latest Posts</h3>
        <ul>
          
          <li><a href="/blog/Object_and_memory/">JNI 객체 사용과 메모리 관리</a></li>
          
          <li><a href="/blog/JNI/">JNI로 C와 Java 연동하기</a></li>
          
          <li><a href="/blog/Font-Display/">임베디드 환경에서 폰트 출력하기</a></li>
          
          <li><a href="/blog/IgH-EtherCAT/">IgH EtherCAT Master Stack API 분석</a></li>
          
        </ul>
      </div>
      <div class="col-md-3">
        <h3>Contact</h3>
        <p>Email:<a href="mailto:khlee.avo@gmail.com"> khlee.avo@gmail.com</a></p>
        <!-- <p>Phone:<a href="tel:"> </a></p> -->
        <!--Start of Tidio.to Script-->
        <!-- <script src="//code.tidio.co/atcbwe5jq0ftiidebmmfwybic3nagfnf.js" async></script> -->
        <!--End of Tidio.to Script-->
      </div>
    </div>
  </div>
</footer>
    </div>

    <!-- JQuery  -->
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
      integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
      integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
      crossorigin="anonymous"
    ></script>

    <script src="/assets/js/owl.carousel.min.js"></script>

    <!-- Navbar shrink on scroll -->
    <script>
      $(window).scroll(function () {
        if ($(document).scrollTop() > 50) {
          $(".navbar").addClass("shrink");
        } else {
          $(".navbar").removeClass("shrink");
        }
      });
    </script>

    <script>
      $(document).ready(function () {
        $(window).scroll(function () {
          if ($(this).scrollTop() > 100) {
            $(".scrollup").fadeIn();
          } else {
            $(".scrollup").fadeOut();
          }
        });

        $(".scrollup").click(function () {
          $("html, body").animate(
            {
              scrollTop: 0,
            },
            600
          );
          return false;
        });
      });
    </script>

    <!-- SlideDown on click -->
    <script>
      $(document).ready(function () {
        $(".doshow").click(function () {
          var that = $(this).next(".noshow");
          $(that).slideToggle("slow");
          $(".noshow").not(that).slideUp("slow");
        });
      });
    </script>

    <!-- Hide Loader on load -->
    <script>
      $(document).ready(function () {
        $(".loader").hide();
      });
    </script>

    <!-- Reveal items on scroll -->
    <script
      type="text/javascript"
      src="/assets/js/scrollreveal.min.js"
    ></script>
    <script>
      window.sr = ScrollReveal();
      sr.reveal(".rev", {
        duration: 1000,
      });
    </script>

    
  </body>
</html>
