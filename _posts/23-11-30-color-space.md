---
title: "Color Space: Linear and Gamma"
image: /assets/post/23-11-30-color-space/color_space.png
image-source: https://ko.wikipedia.org/wiki/SRGB
author: khlee
categories:
    - Unity
layout: post
---

## 개요

Unity의 Player Settings에는 Color Space를 Linear 또는 Gamma로 설정할 수 있는 항목이 있다. 현재 진행중인 프로젝트의 Color Space를 바꿔보면 씬의 룩이 크게 변한다.

![Unity color space setting]({{site.baseurl}}/assets/post/23-11-30-color-space/color_space_setting.png){: width="480" .custom-align-center-img}

한편으로는, 쉐이더를 개발하다 보면 예상한 색깔이 나오지 않는 경우가 종종 있다. 여기에 Color Space가 그 원인인 경우가 종종 있다. 이번 포스트에서는 씬의 룩에 큰 영향을 미치는 Color Space에 대해 상세하게 알아 볼 것이다.

## 베버의 법칙

사람은 자극의 차이를 구분할 때 그 자극의 절대적인 강도가 아닌 비교하고자 하는 자극에 비해 "몇 배" 차이가 나는지에 따라 구분한다. 예를 들어 $$A$$, $$B$$, $$C$$가 각각 소리의 크기라고 할 때 있고 사람이 $$A$$, $$B$$의 소리 크기 차이와 $$B$$, $$C$$의 소리 크기 차이를 동일하게 느끼려면 다음을 만족해야 한다.

$$
\frac{B}{A} = \frac{C}{B}
$$

간단히 값을 대입해서 예시를 살펴보면, $$A=10$$, $$B=20$$일 때 사람이 $$A$$, $$B$$의 소리 크기 차이와 $$B$$, $$C$$의 소리 크기 차이를 동일하게 느끼려면 $$C=30$$이 아닌 $$C=40$$이어야 한다. 이러한 현상은 소리 뿐만 아니라 사람이 느끼는 모든 것에 적용된다. 전 재산이 만원일 때 만원이 더 생기는 것과 전 재산이 1억일 때 만원이 더 생기는 것을 비교해 보면 둘 다 똑같이 만원이 증가했는데도 느껴지는 것에 차이가 있는 것의 원리가 바로 베버의 법칙이다.

베버의 법칙은 밝기의 강도에도 동일하게 적용된다. 아래의 검정-흰색 그라데이션을 보면

![Unity color space setting]({{site.baseurl}}/assets/post/23-11-30-color-space/grad_gamma_linear.png)

A보다 B가 더 밝기가 고르게 분배된 것 처럼 보이지만, 실제 "밝기의 강도"가 고르게 분배된 것은 A이다. 베버의 법칙으로 인해 A의 어두운 영역(왼쪽 영역)에서는 밝기가 더 많이 변하고 밝은 영역(오른쪽 영역)에서는 밝기가 더 적게 변하는 것으로 느끼기 때문이다.

## 모니터의 감마 보정과 sRGB

사람이 느끼기에 검정색과 흰색의 정확히 중간 색상을 모니터에 출력하고 싶다고 해 보자. 검정색을 $$0$$으로 표현하고 흰색을 $$1$$로 표현하면 중간 값은 $$0.5$$가 될 것이다. (실제로는 RGB 또는 A까지 3~4개의 색상 채널이 있겠지만 이 예시에서는 단순화하기 위해 모든 RGB 값이 동일하다고 가정한다.) 이제 이미지 파일에 $$0.5$$라는 값을 저장하자. 만약에 모니터가 이미지 파일을 화면에 출력하기 위해 $$0.5$$라는 값을 받아 그에 따라 검정색과 흰색의 정확히 "중간 강도"로 출력한다고 하면, 사람이 느끼기에는 이 색상이 검정색과 흰색을 중간 색상보다 밝게 보일 것이다. 위의 그라데이션에서 A의 중간 색상에 해당하는 것이다. 이를 해결하기 위한 방법은 두 가지가 있다. 첫 번째는 이미지에 $$0.5$$가 아닌 더 작은, 그러니까 사람이 느끼기에 중간 색상이 되는 값을 저장하는 것이다. 이를 위해서는 다음과 같은 연산을 하면 된다.

$$0.5^2.2 \approx 0.21764$$

이 연산을 감마 보정이라고 하고 $$2.2$$ 감마 값이 된다. (또는 그 역수인 $$1/{2.2} \approx 0.45455$$를 감마 값으로 보기도 한다.) 이제 이미지 파일에는 $$0.5$$ 대신 $$0.21764$$가 저장이 되고 모니터는 검정색과 흰색의 $$0.21764$$ 정도 "강도"가 되는 색상을 출력하며, 사람은 이 색상을 중간 색상이라고 느낄 것이다.

두 번째 방법은 이미지에 저장하는 값은 $$0.5$$ 그대로 두고, 모니터에서 이미지를 출력할 때 감마 보정을 하는 것이다. 모니터가 $$0.5$$라는 값을 받으면 감마 보정을 해서 $$0.21764$$에 해당하는 "강도"의 색상을 출력하는 것이다. 실제 모니터가 이렇게 감마 보정을 수행하도록 되어 있다. 이제 이미지에 저장된 $$0.5$$라는 의미는 검정색과 흰색의 "중간 강도"를 의미하지 않게 된다. $$0.5$$는 사람이 느끼기에 검정색과 흰색의 "중간 색상"이라는 의미를 갖게 되고 모니터에 출력하기 위해서는 감마 보정을 해야 하게 되었다. 이미지에 저장된 각각의 픽셀 값이 이렇게 해석될 때 이 이미지는 sRGB 색 공간으로 저장되었다고 할 수 있다.

Color space에 관한 일부 설명에서 이렇게 저장된 이미지를 "밝게" 저장되었다고 설명하고 있다. 그러나 이것은 애매한 설명이다. $$0.5$$라는 값 자체는, 그러니까 이미지 파일에 들어있는 데이터들은 그 자체만으로 밝다, 어둡다라고 정의할 수 없다. 이미지 파일에 들어있는 데이터를 sRGB 색 공간이든 어떤 것으로 해석하고 모니터에 그 해석에 따라 출력해야 비로소 밝은지 아닌지 그 색상을 알 수 있다. 만약 이 이미지 파일에 들어있는 데이터를 감마 보정을 하지 않고 모니터에 출력한다면 감마 보정을 하기 전보다 밝게 출력될 것이다. 이미지가 "밝게" 저장되어 있다는 것의 의미는 이런 의미이다. 즉 감마 보정을 하면 감마 보정을 하지 않을 때보다 어두워진다는 것이다.

## 리니어 파이프라인과 감마 파이프라인

유니티의 Color space를 Linear로 설정하면 리니어 파이프라인이 동작하고 Gamma로 설정하면 감마 파이프라인이 동작한다. 이 파이프라인은 프래그먼트 쉐이더에서 텍스쳐를 샘플링하고 결과 색상을 저장하는 데에 영향을 준다.

먼저 감마 파이프라인부터 살펴보자. 감마 파이프라인에서는 텍스쳐를 샘플링할 때 어떤 보정도 없이 파일에 저장된 값을 그대로 가져온다. 예를 들어 위에서 예로 든 $$0.5$$라는 값이 저장된 이미지 파일을 샘플링하면, 다음 쉐이더 코드의 `color`의 RGB가 각각 $$0.5$$가 될 것이다.

{% highlight hlsl %}
fixed4 frag(v2f IN) : SV_Target
{
    half4 color = (tex2D(_MainTex, IN.texcoord) + _TextureSampleAdd);
    return color;
}

{% endhighlight %}

반면 리니어 파이프라인에서는 해당 텍스쳐가 sRGB 색 공간으로 저장되어 있는지 아닌지를 확인하고, sRGB 색 공간으로 저장되어 있다면 텍스쳐를 샘플링할 때 자동으로 감마 보정을 수행한다!

텍스쳐의 Import Setting에 보면 아래 사진과 같이 Format을 설정해줄 수 있다.

![Texture import settings]({{site.baseurl}}/assets/post/23-11-30-color-space/texture_import_settings.png){: width="480" .custom-align-center-img}

이 중에서 Automatic이거나 RGBA32 등으로 설정하면 그 아래에 다음과 같이 이 텍스쳐의 색 공간이 sRGB라는 것을 확인할 수 있다.

![sRGB texture]({{site.baseurl}}/assets/post/23-11-30-color-space/srgb_texture.png){: width="480" .custom-align-center-img}

이렇게 $$0.5$$라는 값이 저장된 이미지 파일이 sRGB 색 공간이라면 위와 동일한 다음의 쉐이더 코드의 `color`의 RGB는 감마 보정이 수행된 값인 $$0.21764$$가 될 것이다. 이렇게 sRGB 색 공간에서 감마 보정을 수행하고 난 값은 Linear 색 공간에 있다고 표현한다. 즉 리니어 파이프라인의 프레그먼트 쉐이더에서는 Lieanr 색 공간에서 연산이 이루어지고, 감마 파이프라인의 프래그먼트 쉐이더에서는 sRGB 색 공간에서 연산이 이루어진다.

{% highlight hlsl %}
fixed4 frag(v2f IN) : SV_Target
{
    half4 color = (tex2D(_MainTex, IN.texcoord) + _TextureSampleAdd);
    return color;
}

{% endhighlight %}

리니어 파이프라인과 감마 파이프라인은 텍스쳐를 샘플링하는 것 외에도 결과 색상을 저장하는 데에도 차이가 있다. 감마 파이프라인은 텍스쳐를 샘플링할 때 어떤 보정도 없이 그대로 가져왔으므로 저장할 때에도 그대로 저장한다. 반면 리니어 파이프라인에서는 텍스쳐를 샘플링할 때 감마 보정을 수행했으므로 저장할 때 다시 돌려 놓아야 한다. 이는 아래와 같은 연산을 통해 이루어진다. (사실 이 연산도 감마 보정이다! 감마 값을 사용해서 이미지의 밝기를 조정하는 모든 연산이 감마 보정에 해당한다.)

$$color_{sRGB} = (color_{linear})^{1/2.2}$$

쉐이더에서 연산을 할 때에는 리니어 색 공간에서 연산해야 수학적으로 더 정확하다. 리니어 색 공간이 실제 모니터 밝기의 강도와 리니어한 관계에 있기 때문에다. sRGB 색 공간(감마 색 공간)은 사람이 보기에는 리니어하지만 실제 밝기의 강도와는 비리니어(non-linear)하다. 따라서 감마 파이프라인에서 연산을 수행하는 경우 실제 원하는 밝기의 강도에 비해 큰 값에서 연산이 수행되기 때문에 결과적으로 너무 밝아진다. 아래의 예시의 Linear Space에서는 밝기의 강도가 강해질수록 오브젝트의 밝기도 선형적으로 증가하는 반면 Gamma Space에서는 밝기의 강도가 강해질수록 훨씬 더 밝아지고 빛에 타는 듯한 느낌을 주게 된다.

![Linear and Gamma pipeline - Head scan]({{site.baseurl}}/assets/post/23-11-30-color-space/LinearRendering-Infinite3DHeadScan.jpg){: width="640" .custom-align-center-img}*출처 : 유니티 매뉴얼 문서*{: .custom-caption}

또한 알파 블랜딩도 리니어 파이프라인에서의 연산이 더 정확하다. sRGB 색 공간에서 연산을 하는 경우 리니어 색 공간에 비해 큰 값에서 연산이 수행되기 때문에 아래의 2번째 그림과 같이 채도가 과도하게 높아진다.

![Linear and Gamma pipeline - Blending]({{site.baseurl}}/assets/post/23-11-30-color-space/LinearRendering-BlendingLinearGamma.jpg){: width="640" .custom-align-center-img}*출처 : 유니티 매뉴얼 문서*{: .custom-caption}
